<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•æ„Ÿè¯æ£€æµ‹æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        h2 {
            color: #555;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        textarea {
            width: 100%;
            height: 120px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
        }
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px 5px 0 0;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .safe {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .forbidden {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .test-samples {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .sample-button {
            background: #28a745;
            font-size: 12px;
            padding: 8px 12px;
        }
        .sample-button:hover {
            background: #218838;
        }
        .stats {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
        }
        .loading {
            color: #007bff;
            font-style: italic;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>æ•æ„Ÿè¯æ£€æµ‹æµ‹è¯•é¡µé¢</h1>

    <div class="container">
        <h2>ğŸ” æ–‡æœ¬æ£€æµ‹</h2>
        <textarea id="textInput" placeholder="åœ¨è¿™é‡Œè¾“å…¥è¦æ£€æµ‹çš„æ–‡æœ¬..."></textarea>
        <div>
            <button onclick="testAhoCorasick()">AhoCorasick æ£€æµ‹</button>
            <button onclick="testRealWorldDetector()">RealWorld æ£€æµ‹</button>
            <button onclick="testAzureModerator()">Azure æ£€æµ‹</button>
            <button onclick="testCombined()" style="background: #28a745;">ğŸ”¥ ç»„åˆæ£€æµ‹</button>
            <button onclick="testAll()">å…¨éƒ¨æ£€æµ‹</button>
            <button onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
        </div>

        <h3>ğŸ“ æµ‹è¯•æ ·æœ¬</h3>
        <div class="test-samples">
            <button class="sample-button" onclick="setSample('ä»Šå¤©å¤©æ°”ä¸é”™ï¼Œé€‚åˆå‡ºå»èµ°èµ°')">å®‰å…¨æ–‡æœ¬</button>
            <button class="sample-button" onclick="setSample('ä½ è¿™ä¸ªå‚»é€¼')">ç²—ä¿—è¾±éª‚</button>
            <button class="sample-button" onclick="setSample('ä¹ è¿‘å¹³æ˜¯ç‹¬è£')">æ”¿æ²»æ•æ„Ÿ</button>
            <button class="sample-button" onclick="setSample('æˆ‘è¦æ€äº†ä½ ')">æš´åŠ›å¨èƒ</button>
            <button class="sample-button" onclick="setSample('æˆ¿ä»·å¤ªé«˜ï¼Œæ•™è‚²å†…å·ä¸¥é‡')">è­¦å‘Šçº§åˆ«</button>
            <button class="sample-button" onclick="setSample('æ”¿åºœçš„ç®¡ç†æ°´å¹³éœ€è¦æå‡ï¼Œå¸Œæœ›æ”¿ç­–æ‰§è¡Œæ›´åŠ é€æ˜')">å¤åˆå†…å®¹</button>
            <button class="sample-button" onclick="setSample('I hate you so much')">è‹±æ–‡è¾±éª‚</button>
            <button class="sample-button" onclick="setSample('Kill all the enemies')">è‹±æ–‡æš´åŠ›</button>
        </div>

        <div style="margin-top: 15px; padding: 10px; background: #e8f4fd; border-radius: 4px; border-left: 4px solid #007bff;">
            <strong>ğŸ”¥ ç»„åˆæ£€æµ‹è¯´æ˜ï¼š</strong>
            <ul style="margin: 10px 0 5px 20px; font-size: 14px;">
                <li><strong>æ ¸å¿ƒé€»è¾‘</strong>ï¼šä»»ä½•ä¸€æ–¹ï¼ˆæœ¬åœ°æˆ–Azureï¼‰æ£€æµ‹åˆ°å±é™©å†…å®¹ï¼Œæœ€ç»ˆç»“æœå°±æ˜¯å±é™©</li>
                <li><strong>æœ¬åœ°æ£€æµ‹</strong>ï¼šä¸“æ³¨ä¸­æ–‡æ•æ„Ÿè¯ï¼Œæ”¿æ²»ã€æš´åŠ›ã€è¾±éª‚ç­‰å†…å®¹</li>
                <li><strong>Azureæ£€æµ‹</strong>ï¼šå¤šè¯­è¨€æ”¯æŒï¼ŒAIé©±åŠ¨çš„å†…å®¹å®‰å…¨åˆ†æ</li>
                <li><strong>ä¼˜åŠ¿</strong>ï¼šäº’è¡¥è¦†ç›–ï¼Œå‡å°‘æ¼æ£€ï¼Œæé«˜å‡†ç¡®æ€§</li>
            </ul>
        </div>

        <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 4px; border-left: 4px solid #ffc107;">
            <strong>ğŸ’¡ å¯ç”¨çœŸå®æ£€æµ‹å™¨ï¼š</strong>
            <p style="margin: 5px 0; font-size: 14px;">
                å½“å‰ä½¿ç”¨æ¨¡æ‹Ÿç‰ˆæœ¬ã€‚è¦å¯ç”¨çœŸå®çš„ CombinedDetectorï¼š<br>
                1. è¿è¡Œ <code>bun run build:web</code> æ„å»º Web ç‰ˆæœ¬<br>
                2. åˆ·æ–°é¡µé¢ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åŠ è½½çœŸå®æ£€æµ‹å™¨<br>
                3. çœŸå®ç‰ˆæœ¬å°†æ˜¾ç¤ºæ›´è¯¦ç»†çš„åˆ†æå’Œå‡†ç¡®çš„é£é™©è¯„ä¼°
            </p>
        </div>
    </div>

    <div class="container">
        <h2>âš™ï¸ Azure é…ç½®</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
            <div>
                <label for="azureEndpoint">Azure Endpoint:</label>
                <input type="text" id="azureEndpoint" placeholder="https://your-resource.cognitiveservices.azure.com/contentsafety/text:analyze?api-version=2023-10-01"
                       style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
                <label for="azureKey">Subscription Key:</label>
                <input type="password" id="azureKey" placeholder="your-subscription-key"
                       style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
        </div>
        <button onclick="testAzureConnection()" style="background: #17a2b8;">æµ‹è¯• Azure è¿æ¥</button>
    </div>

    <div class="container">
        <h2>ğŸ“Š æ£€æµ‹ç»“æœ</h2>
        <div id="results"></div>
    </div>

    <!-- å°è¯•åŠ è½½æ„å»ºçš„ Web ç‰ˆæœ¬ -->
    <script src="./dist/index.js" type="module" async></script>

    <script>
        let ahocorasickWorker = null;
        let realWorldDetector = null;
        let combinedDetector = null;
        let sensitiveWordLoader = null;

        // å°è¯•åŠ è½½å®é™…çš„ CombinedDetector
        async function initializeCombinedDetector() {
            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰å…¨å±€çš„ SensitiveWordDetectors å¯¹è±¡
                if (typeof window !== 'undefined' && window.SensitiveWordDetectors) {
                    const { CombinedDetector, SensitiveWordLoader } = window.SensitiveWordDetectors;

                    // åˆå§‹åŒ–æ•æ„Ÿè¯åŠ è½½å™¨ï¼ˆè¿™é‡Œéœ€è¦å®é™…çš„è¯åº“æ•°æ®ï¼‰
                    sensitiveWordLoader = new SensitiveWordLoader();

                    // åˆå§‹åŒ–ç»„åˆæ£€æµ‹å™¨
                    combinedDetector = new CombinedDetector(sensitiveWordLoader);

                    console.log('âœ… å·²åŠ è½½å®é™…çš„ CombinedDetector');
                    return true;
                }

                // å¦åˆ™å°è¯•åŠ¨æ€å¯¼å…¥
                const module = await import('./dist/index.js').catch(() => null);
                if (module && module.CombinedDetector) {
                    const { CombinedDetector, SensitiveWordLoader } = module;

                    // åˆå§‹åŒ–æ•æ„Ÿè¯åŠ è½½å™¨ï¼ˆè¿™é‡Œéœ€è¦å®é™…çš„è¯åº“æ•°æ®ï¼‰
                    sensitiveWordLoader = new SensitiveWordLoader();

                    // åˆå§‹åŒ–ç»„åˆæ£€æµ‹å™¨
                    combinedDetector = new CombinedDetector(sensitiveWordLoader);

                    console.log('âœ… å·²åŠ è½½å®é™…çš„ CombinedDetector (æ¨¡å—å¯¼å…¥)');
                    return true;
                }
            } catch (error) {
                console.warn('âš ï¸ æ— æ³•åŠ è½½å®é™…çš„ CombinedDetectorï¼Œä½¿ç”¨æ¨¡æ‹Ÿç‰ˆæœ¬:', error.message);
            }
            return false;
        }

        // é¡µé¢åŠ è½½æ—¶å°è¯•åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            const loaded = await initializeCombinedDetector();
            if (loaded) {
                // æ›´æ–°ç•Œé¢æç¤º
                const hint = document.createElement('div');
                hint.innerHTML = `
                    <div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                        âœ… <strong>å®é™…æ£€æµ‹å™¨å·²åŠ è½½</strong> - ç°åœ¨ä½¿ç”¨çœŸå®çš„ CombinedDetector è¿›è¡Œæ£€æµ‹
                    </div>
                `;
                document.querySelector('.container').insertAdjacentElement('afterbegin', hint);
            }
        });

        // æ¨¡æ‹Ÿ AhoCorasick æ£€æµ‹ (å®é™…åº”è¯¥è°ƒç”¨åç«¯API)
        async function simulateAhoCorasick(text) {
            // æ¨¡æ‹Ÿä¸€äº›æ£€æµ‹ç»“æœ
            const sensitiveWords = ['å‚»é€¼', 'æ“ä½ å¦ˆ', 'ä¹ è¿‘å¹³', 'å…±äº§å…š', 'æ€äº†ä½ ', 'ç‚¸æ‰', 'æ”¿åºœ', 'å®˜å‘˜'];
            const results = [];

            sensitiveWords.forEach(word => {
                const index = text.indexOf(word);
                if (index !== -1) {
                    results.push({
                        word: word,
                        position: [index, index + word.length],
                        category: word.includes('å‚»') || word.includes('æ“') ? 'è¾±éª‚è¯åº“' :
                                 word.includes('ä¹ ') || word.includes('å…±äº§') ? 'æ”¿æ²»æ•æ„Ÿ' :
                                 word.includes('æ€') || word.includes('ç‚¸') ? 'æš´åŠ›è¯åº“' : 'å…¶ä»–',
                        source: word.includes('å‚»') || word.includes('æ“') ? 'curse.txt' :
                               word.includes('ä¹ ') || word.includes('å…±äº§') ? 'political.txt' :
                               word.includes('æ€') || word.includes('ç‚¸') ? 'violence.txt' : 'other.txt'
                    });
                }
            });

            return results;
        }

        // Azure Content Moderator æ£€æµ‹
        async function callAzureModerator(text) {
            const endpoint = document.getElementById('azureEndpoint').value.trim();
            const subscriptionKey = document.getElementById('azureKey').value.trim();

            if (!endpoint || !subscriptionKey) {
                throw new Error('è¯·å…ˆé…ç½® Azure Endpoint å’Œ Subscription Key');
            }

            const request = {
                text: text
            };

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Ocp-Apim-Subscription-Key': subscriptionKey
                },
                body: JSON.stringify(request),
                signal: AbortSignal.timeout(10000)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Azure API error (${response.status}): ${errorText}`);
            }

            return await response.json();
        }

        // åˆ†æ Azure ç»“æœ
        function analyzeAzureResult(result, options = {}) {
            const highRiskThreshold = options.highRiskThreshold ?? 4;
            const mediumRiskThreshold = options.mediumRiskThreshold ?? 2;

            let maxSeverity = 0;
            const riskCategories = [];
            const severityBreakdown = {};

            for (const category of result.categoriesAnalysis) {
                maxSeverity = Math.max(maxSeverity, category.severity);
                severityBreakdown[category.category] = category.severity;

                if (category.severity >= mediumRiskThreshold) {
                    riskCategories.push(category.category);
                }
            }

            return {
                hasHighRisk: maxSeverity >= highRiskThreshold,
                hasMediumRisk: maxSeverity >= mediumRiskThreshold,
                maxSeverity,
                riskCategories,
                severityBreakdown
            };
        }

        // æ¨¡æ‹Ÿ RealWorldDetector æ£€æµ‹
        async function simulateRealWorldDetector(text) {
            const directCurse = ['å‚»é€¼', 'æ“ä½ å¦ˆ', 'æ“ä½ ', 'sb', 'cnm'];
            const political = ['ä¹ è¿‘å¹³', 'å…±äº§å…š', 'ç‹¬è£', 'ä¸“åˆ¶'];
            const violence = ['æ€äº†ä½ ', 'ç‚¸æ‰', 'æ”¾ç«', 'å¼€æª'];
            const warning = ['æˆ¿ä»·', 'æ•™è‚²å†…å·', 'æ”¿åºœ', 'å®˜å‘˜'];

            const analysis = {
                directMatches: [],
                politicalSensitive: false,
                violenceThreat: false,
                curseWords: false,
                riskScore: 0
            };

            // æ£€æŸ¥å„ç±»è¯æ±‡
            directCurse.forEach(word => {
                if (text.includes(word)) {
                    analysis.curseWords = true;
                    analysis.directMatches.push(word);
                    analysis.riskScore += 10;
                }
            });

            political.forEach(word => {
                if (text.includes(word)) {
                    analysis.politicalSensitive = true;
                    analysis.directMatches.push(word);
                    analysis.riskScore += 8;
                }
            });

            violence.forEach(word => {
                if (text.includes(word)) {
                    analysis.violenceThreat = true;
                    analysis.directMatches.push(word);
                    analysis.riskScore += 9;
                }
            });

            warning.forEach(word => {
                if (text.includes(word)) {
                    analysis.riskScore += 0.5;
                }
            });

            // å†³ç­–é€»è¾‘
            let level, reason, confidence;

            if (analysis.curseWords || analysis.politicalSensitive || analysis.violenceThreat || analysis.riskScore >= 8) {
                level = "forbidden";
                const reasons = [];
                if (analysis.curseWords) reasons.push("ç²—ä¿—è¾±éª‚");
                if (analysis.politicalSensitive) reasons.push("æ”¿æ²»æ•æ„Ÿ");
                if (analysis.violenceThreat) reasons.push("æš´åŠ›å¨èƒ");
                reason = `ä¸¥é‡è¿ç¦å†…å®¹: ${reasons.join(', ')}`;
                confidence = 0.9;
            } else if (analysis.riskScore >= 2 || analysis.directMatches.length >= 2) {
                level = "warning";
                reason = `å¯ç–‘å†…å®¹ (é£é™©åˆ†æ•°: ${analysis.riskScore})`;
                confidence = 0.75;
            } else if (analysis.riskScore >= 0.5) {
                level = "warning";
                reason = "è½»åº¦æ•æ„Ÿå†…å®¹";
                confidence = 0.65;
            } else {
                level = "safe";
                reason = "æ— æ•æ„Ÿå†…å®¹";
                confidence = 0.95;
            }

            return {
                level,
                reason,
                confidence,
                analysis
            };
        }

        async function testAhoCorasick() {
            const text = document.getElementById('textInput').value.trim();
            if (!text) {
                alert('è¯·è¾“å…¥è¦æ£€æµ‹çš„æ–‡æœ¬');
                return;
            }

            const results = document.getElementById('results');
            results.innerHTML = '<div class="loading">æ­£åœ¨è¿›è¡Œ AhoCorasick æ£€æµ‹...</div>';

            try {
                const startTime = performance.now();
                const matches = await simulateAhoCorasick(text);
                const endTime = performance.now();

                const resultHtml = `
<h3>ğŸ” AhoCorasick æ£€æµ‹ç»“æœ</h3>
<div class="result ${matches.length > 0 ? 'warning' : 'safe'}">
æ£€æµ‹åˆ° ${matches.length} ä¸ªæ•æ„Ÿè¯ï¼š
${matches.length > 0 ? matches.map(match =>
    `- "${match.word}" (ä½ç½®: ${match.position[0]}-${match.position[1]}, ç±»åˆ«: ${match.category}, æ¥æº: ${match.source})`
).join('\n') : 'æœªæ£€æµ‹åˆ°æ•æ„Ÿè¯'}

<div class="stats">æ£€æµ‹è€—æ—¶: ${(endTime - startTime).toFixed(2)}ms</div>
</div>`;
                results.innerHTML = resultHtml;
            } catch (error) {
                results.innerHTML = `<div class="result error">æ£€æµ‹å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function testRealWorldDetector() {
            const text = document.getElementById('textInput').value.trim();
            if (!text) {
                alert('è¯·è¾“å…¥è¦æ£€æµ‹çš„æ–‡æœ¬');
                return;
            }

            const results = document.getElementById('results');
            results.innerHTML = '<div class="loading">æ­£åœ¨è¿›è¡Œ RealWorld æ£€æµ‹...</div>';

            try {
                const startTime = performance.now();
                const result = await simulateRealWorldDetector(text);
                const endTime = performance.now();

                const resultHtml = `
<h3>ğŸŒ RealWorld æ£€æµ‹ç»“æœ</h3>
<div class="result ${result.level}">
ç­‰çº§: ${result.level.toUpperCase()}
åŸå› : ${result.reason}
ç½®ä¿¡åº¦: ${(result.confidence * 100).toFixed(1)}%

åˆ†æè¯¦æƒ…:
- ç›´æ¥åŒ¹é…: ${result.analysis.directMatches.join(', ') || 'æ— '}
- æ”¿æ²»æ•æ„Ÿ: ${result.analysis.politicalSensitive ? 'æ˜¯' : 'å¦'}
- æš´åŠ›å¨èƒ: ${result.analysis.violenceThreat ? 'æ˜¯' : 'å¦'}
- ç²—ä¿—è¾±éª‚: ${result.analysis.curseWords ? 'æ˜¯' : 'å¦'}
- é£é™©åˆ†æ•°: ${result.analysis.riskScore}

<div class="stats">æ£€æµ‹è€—æ—¶: ${(endTime - startTime).toFixed(2)}ms</div>
</div>`;
                results.innerHTML = resultHtml;
            } catch (error) {
                results.innerHTML = `<div class="result error">æ£€æµ‹å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function testAzureModerator() {
            const text = document.getElementById('textInput').value.trim();
            if (!text) {
                alert('è¯·è¾“å…¥è¦æ£€æµ‹çš„æ–‡æœ¬');
                return;
            }

            const results = document.getElementById('results');
            results.innerHTML = '<div class="loading">æ­£åœ¨è¿›è¡Œ Azure Content Moderator æ£€æµ‹...</div>';

            try {
                const startTime = performance.now();
                const azureResult = await callAzureModerator(text);
                const analysis = analyzeAzureResult(azureResult);
                const endTime = performance.now();

                const categoryDetails = azureResult.categoriesAnalysis
                    .map(cat => `- ${cat.category}: ${cat.severity}/6 ${cat.severity >= 4 ? 'ğŸ”´' : cat.severity >= 2 ? 'ğŸŸ¡' : 'ğŸŸ¢'}`)
                    .join('\n');

                const blocklistInfo = azureResult.blocklistsMatch && azureResult.blocklistsMatch.length > 0
                    ? `\né˜»æ­¢åˆ—è¡¨åŒ¹é…: ${azureResult.blocklistsMatch.map(match => match.blocklistName).join(', ')}`
                    : '';

                const riskLevel = analysis.hasHighRisk ? 'forbidden' : analysis.hasMediumRisk ? 'warning' : 'safe';
                const riskLabel = analysis.hasHighRisk ? 'é«˜é£é™©' : analysis.hasMediumRisk ? 'ä¸­é£é™©' : 'å®‰å…¨';

                const resultHtml = `
<h3>â˜ï¸ Azure Content Moderator æ£€æµ‹ç»“æœ</h3>
<div class="result ${riskLevel}">
é£é™©ç­‰çº§: ${riskLabel}
æœ€é«˜ä¸¥é‡åº¦: ${analysis.maxSeverity}/6
é£é™©ç±»åˆ«: ${analysis.riskCategories.length > 0 ? analysis.riskCategories.join(', ') : 'æ— '}

è¯¦ç»†åˆ†æ:
${categoryDetails}${blocklistInfo}

<div class="stats">æ£€æµ‹è€—æ—¶: ${(endTime - startTime).toFixed(2)}ms</div>
</div>`;
                results.innerHTML = resultHtml;
            } catch (error) {
                results.innerHTML = `<div class="result error">Azure æ£€æµ‹å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function testAzureConnection() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="loading">æ­£åœ¨æµ‹è¯• Azure è¿æ¥...</div>';

            try {
                const startTime = performance.now();
                const azureResult = await callAzureModerator('Hello world');
                const endTime = performance.now();

                results.innerHTML = `
<h3>â˜ï¸ Azure è¿æ¥æµ‹è¯•ç»“æœ</h3>
<div class="result safe">
è¿æ¥çŠ¶æ€: âœ… æˆåŠŸ
å“åº”æ—¶é—´: ${(endTime - startTime).toFixed(2)}ms
API ç‰ˆæœ¬: æ­£å¸¸å“åº”
</div>`;
            } catch (error) {
                results.innerHTML = `<div class="result error">è¿æ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        // ç»„åˆæ£€æµ‹ï¼šæœ¬åœ°æ¨¡å‹ + Azure
        async function testCombined() {
            const text = document.getElementById('textInput').value.trim();
            if (!text) {
                alert('è¯·è¾“å…¥è¦æ£€æµ‹çš„æ–‡æœ¬');
                return;
            }

            const results = document.getElementById('results');
            results.innerHTML = '<div class="loading">æ­£åœ¨è¿›è¡Œç»„åˆæ£€æµ‹ï¼ˆæœ¬åœ°+Azureï¼‰...</div>';

            try {
                const startTime = performance.now();

                // å¦‚æœæœ‰çœŸå®çš„ CombinedDetectorï¼Œä½¿ç”¨å®ƒ
                if (combinedDetector) {
                    const endpoint = document.getElementById('azureEndpoint').value.trim();
                    const subscriptionKey = document.getElementById('azureKey').value.trim();

                    // å¦‚æœé…ç½®äº† Azureï¼Œè®¾ç½® Azure é…ç½®
                    if (endpoint && subscriptionKey) {
                        combinedDetector.setAzureConfig({
                            endpoint,
                            subscriptionKey,
                            timeout: 10000
                        });
                    }

                    const result = await combinedDetector.detect(text);
                    const endTime = performance.now();

                    displayRealCombinedResult(result, endTime - startTime);
                    return;
                }

                // å¦åˆ™ä½¿ç”¨æ¨¡æ‹Ÿç‰ˆæœ¬
                await testCombinedSimulation(text, startTime);

            } catch (error) {
                results.innerHTML = `<div class="result error">ç»„åˆæ£€æµ‹å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ˜¾ç¤ºçœŸå®çš„ CombinedDetector ç»“æœ
        function displayRealCombinedResult(result, duration) {
            const results = document.getElementById('results');
            const details = result.details;

            let resultHtml = `
<h3>ğŸ”¥ çœŸå®ç»„åˆæ£€æµ‹ç»“æœ (CombinedDetector)</h3>
<div class="result ${result.level}">
<strong>æœ€ç»ˆå†³ç­–: ${result.level.toUpperCase()}</strong>
åŸå› : ${result.reason}
ç½®ä¿¡åº¦: ${(result.confidence * 100).toFixed(1)}%
è§¦å‘æ–¹: ${details.finalDecision.triggeredBy}

<strong>å†³ç­–æ¨ç†:</strong>
${details.finalDecision.reasoning}
</div>

<h3>ğŸ“Š è¯¦ç»†åˆ†æ</h3>

<h4>ğŸŒ æœ¬åœ°æ£€æµ‹ (RealWorld)</h4>
<div class="result ${details.local.level}">
ç­‰çº§: ${details.local.level.toUpperCase()}
åŸå› : ${details.local.reason}
ç½®ä¿¡åº¦: ${(details.local.confidence * 100).toFixed(1)}%
é£é™©åˆ†æ•°: ${details.local.analysis.riskScore}
ç›´æ¥åŒ¹é…: ${details.local.analysis.directMatches.join(', ') || 'æ— '}
</div>`;

            if (details.azure) {
                if (details.azure.available && details.azure.result) {
                    const analysis = details.azure.analysis;
                    const categoryDetails = details.azure.result.categoriesAnalysis
                        .map(cat => `${cat.category}: ${cat.severity}/6 ${cat.severity >= 4 ? 'ğŸ”´' : cat.severity >= 2 ? 'ğŸŸ¡' : 'ğŸŸ¢'}`)
                        .join(', ');

                    const azureLevel = analysis.hasHighRisk ? 'forbidden' : analysis.hasMediumRisk ? 'warning' : 'safe';

                    resultHtml += `
<h4>â˜ï¸ Azure Content Moderator</h4>
<div class="result ${azureLevel}">
é£é™©ç­‰çº§: ${analysis.hasHighRisk ? 'é«˜é£é™©' : analysis.hasMediumRisk ? 'ä¸­é£é™©' : 'å®‰å…¨'}
æœ€é«˜ä¸¥é‡åº¦: ${analysis.maxSeverity}/6
é£é™©ç±»åˆ«: ${analysis.riskCategories.length > 0 ? analysis.riskCategories.join(', ') : 'æ— '}
è¯¦ç»†åˆ†æ: ${categoryDetails}
</div>`;
                } else if (details.azure.error) {
                    resultHtml += `
<h4>â˜ï¸ Azure Content Moderator</h4>
<div class="result error">
Azure æ£€æµ‹å¤±è´¥: ${details.azure.error}
</div>`;
                } else {
                    resultHtml += `
<h4>â˜ï¸ Azure Content Moderator</h4>
<div class="result warning">
âš ï¸ Azure æ£€æµ‹æœªå¯ç”¨
</div>`;
                }
            }

            resultHtml += `<div class="stats">æ£€æµ‹è€—æ—¶: ${duration.toFixed(2)}ms</div>`;
            results.innerHTML = resultHtml;
        }

        // æ¨¡æ‹Ÿç‰ˆæœ¬çš„ç»„åˆæ£€æµ‹
        async function testCombinedSimulation(text, startTime) {
            // å¹¶è¡Œæ‰§è¡Œæœ¬åœ°å’ŒAzureæ£€æµ‹
            const realWorldResult = await simulateRealWorldDetector(text);

            let azureResult = null;
            let azureError = null;
            let azureAnalysis = null;

            const endpoint = document.getElementById('azureEndpoint').value.trim();
            const subscriptionKey = document.getElementById('azureKey').value.trim();
            const azureConfigured = endpoint && subscriptionKey;

            if (azureConfigured) {
                try {
                    azureResult = await callAzureModerator(text);
                    azureAnalysis = analyzeAzureResult(azureResult);
                } catch (error) {
                    azureError = error.message;
                }
            }

            const endTime = performance.now();

            // ç»¼åˆå†³ç­–é€»è¾‘
            const combinedDecision = makeCombinedDecision(realWorldResult, azureAnalysis, azureError, azureConfigured);

            let resultHtml = `
<h3>ğŸ”¥ ç»„åˆæ£€æµ‹ç»“æœ (æœ¬åœ°+Azure)</h3>
<div class="result ${combinedDecision.finalLevel}">
<strong>æœ€ç»ˆå†³ç­–: ${combinedDecision.finalLevel.toUpperCase()}</strong>
åŸå› : ${combinedDecision.finalReason}
ç½®ä¿¡åº¦: ${(combinedDecision.finalConfidence * 100).toFixed(1)}%
è§¦å‘æ–¹: ${combinedDecision.triggeredBy}

<strong>å†³ç­–é€»è¾‘:</strong>
${combinedDecision.reasoning}
</div>

<h3>ğŸ“Š è¯¦ç»†åˆ†æ</h3>

<h4>ğŸŒ æœ¬åœ°æ£€æµ‹ (RealWorld)</h4>
<div class="result ${realWorldResult.level}">
ç­‰çº§: ${realWorldResult.level.toUpperCase()}
åŸå› : ${realWorldResult.reason}
ç½®ä¿¡åº¦: ${(realWorldResult.confidence * 100).toFixed(1)}%
é£é™©åˆ†æ•°: ${realWorldResult.analysis.riskScore}
ç›´æ¥åŒ¹é…: ${realWorldResult.analysis.directMatches.join(', ') || 'æ— '}
</div>`;

            if (azureConfigured) {
                if (azureError) {
                    resultHtml += `
<h4>â˜ï¸ Azure æ£€æµ‹</h4>
<div class="result error">
Azure æ£€æµ‹å¤±è´¥: ${azureError}
</div>`;
                } else if (azureResult && azureAnalysis) {
                    const categoryDetails = azureResult.categoriesAnalysis
                        .map(cat => `${cat.category}: ${cat.severity}/6 ${cat.severity >= 4 ? 'ğŸ”´' : cat.severity >= 2 ? 'ğŸŸ¡' : 'ğŸŸ¢'}`)
                        .join(', ');

                    const azureLevel = azureAnalysis.hasHighRisk ? 'forbidden' : azureAnalysis.hasMediumRisk ? 'warning' : 'safe';

                    resultHtml += `
<h4>â˜ï¸ Azure Content Moderator</h4>
<div class="result ${azureLevel}">
é£é™©ç­‰çº§: ${azureAnalysis.hasHighRisk ? 'é«˜é£é™©' : azureAnalysis.hasMediumRisk ? 'ä¸­é£é™©' : 'å®‰å…¨'}
æœ€é«˜ä¸¥é‡åº¦: ${azureAnalysis.maxSeverity}/6
é£é™©ç±»åˆ«: ${azureAnalysis.riskCategories.length > 0 ? azureAnalysis.riskCategories.join(', ') : 'æ— '}
è¯¦ç»†åˆ†æ: ${categoryDetails}
</div>`;
                }
            } else {
                resultHtml += `
<h4>â˜ï¸ Azure Content Moderator</h4>
<div class="result warning">
âš ï¸ æœªé…ç½® Azure å‚æ•°ï¼Œä»…ä½¿ç”¨æœ¬åœ°æ£€æµ‹
</div>`;
            }

            resultHtml += `<div class="stats">æ€»æ£€æµ‹è€—æ—¶: ${(endTime - startTime).toFixed(2)}ms</div>`;
            const results = document.getElementById('results');
            results.innerHTML = resultHtml;
        }

        // ç»„åˆå†³ç­–é€»è¾‘
        function makeCombinedDecision(localResult, azureAnalysis, azureError, azureConfigured) {
            // å¦‚æœAzureä¸å¯ç”¨ï¼Œä»…ä½¿ç”¨æœ¬åœ°ç»“æœ
            if (!azureConfigured || azureError) {
                return {
                    finalLevel: localResult.level,
                    finalReason: localResult.reason,
                    finalConfidence: localResult.confidence,
                    triggeredBy: 'æœ¬åœ°æ£€æµ‹',
                    reasoning: azureError
                        ? `Azureæ£€æµ‹å¤±è´¥ (${azureError})ï¼Œé‡‡ç”¨æœ¬åœ°æ£€æµ‹ç»“æœ`
                        : 'Azureæœªé…ç½®ï¼Œé‡‡ç”¨æœ¬åœ°æ£€æµ‹ç»“æœ'
                };
            }

            const localForbidden = localResult.level === 'forbidden';
            const localWarning = localResult.level === 'warning';
            const azureForbidden = azureAnalysis.hasHighRisk;
            const azureWarning = azureAnalysis.hasMediumRisk;

            // æ ¸å¿ƒè§„åˆ™ï¼šä»»ä½•ä¸€æ–¹åˆ¤å®šä¸ºå±é™©ï¼Œæœ€ç»ˆç»“æœå°±æ˜¯å±é™©
            if (localForbidden || azureForbidden) {
                let triggeredBy = '';
                let reasoning = '';

                if (localForbidden && azureForbidden) {
                    triggeredBy = 'æœ¬åœ°+Azure';
                    reasoning = `æœ¬åœ°å’ŒAzureéƒ½æ£€æµ‹åˆ°é«˜é£é™©å†…å®¹ã€‚æœ¬åœ°: ${localResult.reason}; Azure: æœ€é«˜ä¸¥é‡åº¦${azureAnalysis.maxSeverity}/6`;
                } else if (localForbidden) {
                    triggeredBy = 'æœ¬åœ°æ£€æµ‹';
                    reasoning = `æœ¬åœ°æ£€æµ‹åˆ°é«˜é£é™©å†…å®¹: ${localResult.reason}ã€‚Azureè®¤ä¸ºç›¸å¯¹å®‰å…¨ (ä¸¥é‡åº¦${azureAnalysis.maxSeverity}/6)ï¼Œä½†é‡‡ç”¨æ›´ä¸¥æ ¼çš„æœ¬åœ°æ ‡å‡†`;
                } else {
                    triggeredBy = 'Azureæ£€æµ‹';
                    reasoning = `Azureæ£€æµ‹åˆ°é«˜é£é™©å†…å®¹ (ä¸¥é‡åº¦${azureAnalysis.maxSeverity}/6ï¼Œç±»åˆ«: ${azureAnalysis.riskCategories.join(', ')})ã€‚æœ¬åœ°æ£€æµ‹ç›¸å¯¹å®½æ¾ï¼Œä½†éµå¾ªAzureçš„ä¸¥æ ¼æ ‡å‡†`;
                }

                return {
                    finalLevel: 'forbidden',
                    finalReason: `é«˜é£é™©å†…å®¹ (${triggeredBy})`,
                    finalConfidence: Math.max(localResult.confidence, 0.9),
                    triggeredBy,
                    reasoning
                };
            }

            // ä»»ä½•ä¸€æ–¹åˆ¤å®šä¸ºè­¦å‘Šï¼Œæœ€ç»ˆç»“æœå°±æ˜¯è­¦å‘Š
            if (localWarning || azureWarning) {
                let triggeredBy = '';
                let reasoning = '';

                if (localWarning && azureWarning) {
                    triggeredBy = 'æœ¬åœ°+Azure';
                    reasoning = `æœ¬åœ°å’ŒAzureéƒ½æ£€æµ‹åˆ°ä¸­ç­‰é£é™©ã€‚æœ¬åœ°: ${localResult.reason}; Azure: ä¸¥é‡åº¦${azureAnalysis.maxSeverity}/6`;
                } else if (localWarning) {
                    triggeredBy = 'æœ¬åœ°æ£€æµ‹';
                    reasoning = `æœ¬åœ°æ£€æµ‹åˆ°ä¸­ç­‰é£é™©: ${localResult.reason}`;
                } else {
                    triggeredBy = 'Azureæ£€æµ‹';
                    reasoning = `Azureæ£€æµ‹åˆ°ä¸­ç­‰é£é™© (ä¸¥é‡åº¦${azureAnalysis.maxSeverity}/6)`;
                }

                return {
                    finalLevel: 'warning',
                    finalReason: `ä¸­ç­‰é£é™©å†…å®¹ (${triggeredBy})`,
                    finalConfidence: Math.max(localResult.confidence, 0.8),
                    triggeredBy,
                    reasoning
                };
            }

            // ä¸¤è€…éƒ½è®¤ä¸ºå®‰å…¨
            return {
                finalLevel: 'safe',
                finalReason: 'æœ¬åœ°å’ŒAzureæ£€æµ‹å‡æœªå‘ç°æ•æ„Ÿå†…å®¹',
                finalConfidence: Math.min(localResult.confidence, 0.95),
                triggeredBy: 'æ— ',
                reasoning: `æœ¬åœ°æ£€æµ‹: ${localResult.reason}; Azureæ£€æµ‹: æœ€é«˜ä¸¥é‡åº¦${azureAnalysis.maxSeverity}/6ï¼Œæ— é£é™©å†…å®¹`
            };
        }

        async function testAll() {
            const text = document.getElementById('textInput').value.trim();
            if (!text) {
                alert('è¯·è¾“å…¥è¦æ£€æµ‹çš„æ–‡æœ¬');
                return;
            }

            const results = document.getElementById('results');
            results.innerHTML = '<div class="loading">æ­£åœ¨è¿›è¡Œå…¨éƒ¨æ£€æµ‹...</div>';

            try {
                const startTime = performance.now();

                // æ£€æŸ¥ Azure æ˜¯å¦é…ç½®
                const endpoint = document.getElementById('azureEndpoint').value.trim();
                const subscriptionKey = document.getElementById('azureKey').value.trim();
                const azureConfigured = endpoint && subscriptionKey;

                let promises = [
                    simulateAhoCorasick(text),
                    simulateRealWorldDetector(text)
                ];

                if (azureConfigured) {
                    promises.push(callAzureModerator(text));
                }

                const results_data = await Promise.all(promises);
                const [ahoMatches, realWorldResult, azureResult] = results_data;
                const endTime = performance.now();

                let resultHtml = `
<h3>ğŸ” AhoCorasick æ£€æµ‹ç»“æœ</h3>
<div class="result ${ahoMatches.length > 0 ? 'warning' : 'safe'}">
æ£€æµ‹åˆ° ${ahoMatches.length} ä¸ªæ•æ„Ÿè¯ï¼š
${ahoMatches.length > 0 ? ahoMatches.map(match =>
    `- "${match.word}" (ä½ç½®: ${match.position[0]}-${match.position[1]}, ç±»åˆ«: ${match.category})`
).join('\n') : 'æœªæ£€æµ‹åˆ°æ•æ„Ÿè¯'}
</div>

<h3>ğŸŒ RealWorld æ£€æµ‹ç»“æœ</h3>
<div class="result ${realWorldResult.level}">
ç­‰çº§: ${realWorldResult.level.toUpperCase()}
åŸå› : ${realWorldResult.reason}
ç½®ä¿¡åº¦: ${(realWorldResult.confidence * 100).toFixed(1)}%

åˆ†æè¯¦æƒ…:
- ç›´æ¥åŒ¹é…: ${realWorldResult.analysis.directMatches.join(', ') || 'æ— '}
- æ”¿æ²»æ•æ„Ÿ: ${realWorldResult.analysis.politicalSensitive ? 'æ˜¯' : 'å¦'}
- æš´åŠ›å¨èƒ: ${realWorldResult.analysis.violenceThreat ? 'æ˜¯' : 'å¦'}
- ç²—ä¿—è¾±éª‚: ${realWorldResult.analysis.curseWords ? 'æ˜¯' : 'å¦'}
- é£é™©åˆ†æ•°: ${realWorldResult.analysis.riskScore}
</div>`;

                if (azureConfigured && azureResult) {
                    const analysis = analyzeAzureResult(azureResult);
                    const categoryDetails = azureResult.categoriesAnalysis
                        .map(cat => `- ${cat.category}: ${cat.severity}/6 ${cat.severity >= 4 ? 'ğŸ”´' : cat.severity >= 2 ? 'ğŸŸ¡' : 'ğŸŸ¢'}`)
                        .join('\n');

                    const riskLevel = analysis.hasHighRisk ? 'forbidden' : analysis.hasMediumRisk ? 'warning' : 'safe';
                    const riskLabel = analysis.hasHighRisk ? 'é«˜é£é™©' : analysis.hasMediumRisk ? 'ä¸­é£é™©' : 'å®‰å…¨';

                    resultHtml += `
<h3>â˜ï¸ Azure Content Moderator æ£€æµ‹ç»“æœ</h3>
<div class="result ${riskLevel}">
é£é™©ç­‰çº§: ${riskLabel}
æœ€é«˜ä¸¥é‡åº¦: ${analysis.maxSeverity}/6
é£é™©ç±»åˆ«: ${analysis.riskCategories.length > 0 ? analysis.riskCategories.join(', ') : 'æ— '}

è¯¦ç»†åˆ†æ:
${categoryDetails}
</div>`;
                } else if (!azureConfigured) {
                    resultHtml += `
<h3>â˜ï¸ Azure Content Moderator æ£€æµ‹ç»“æœ</h3>
<div class="result warning">
âš ï¸ æœªé…ç½® Azure å‚æ•°ï¼Œè·³è¿‡ Azure æ£€æµ‹
</div>`;
                }

                resultHtml += `<div class="stats">æ€»æ£€æµ‹è€—æ—¶: ${(endTime - startTime).toFixed(2)}ms</div>`;
                results.innerHTML = resultHtml;
            } catch (error) {
                results.innerHTML = `<div class="result error">æ£€æµ‹å¤±è´¥: ${error.message}</div>`;
            }
        }

        function setSample(text) {
            document.getElementById('textInput').value = text;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('æ•æ„Ÿè¯æ£€æµ‹æµ‹è¯•é¡µé¢å·²åŠ è½½');
        });
    </script>
</body>
</html>